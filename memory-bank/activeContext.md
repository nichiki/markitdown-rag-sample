# アクティブコンテキスト

## 現在の作業フォーカス

現在、プロジェクトはStreamlit UIの実装フェーズを完了し、統合テストと最適化フェーズに移行しています。Microsoftの「markitdown」リポジトリを活用して、RAG機能とドキュメント管理UIを備えた検証用アプリケーションを開発しています。

### 直近のタスク（完了）

1. プロジェクト構造の設定 ✓
   - ディレクトリ構造の作成
   - 必要なファイルの初期化

2. 依存関係の設定 ✓
   - pyproject.tomlの更新
   - 必要なライブラリのインストール手順のドキュメント化

3. 環境変数の設定 ✓
   - .env.exampleファイルの確認
   - OpenAI APIキーなどの設定方法のドキュメント化

4. ドキュメント処理機能の実装 ✓
   - DocumentProcessorクラスのテスト作成
   - DocumentProcessorクラスの実装
   - ドキュメント変換機能のテスト
   - ドキュメント保存機能のテスト

5. ベクトルデータベース機能の実装 ✓
   - VectorStoreクラスのテスト作成
   - VectorStoreクラスの実装
   - チャンク分割機能のテスト
   - 埋め込み生成機能のテスト
   - 検索機能のテスト

6. RAG機能の実装 ✓
   - RAGクラスのテスト作成
   - RAGクラスの実装
   - 検索機能のテスト
   - 回答生成機能のテスト
   - クエリ実行機能のテスト

### 次のステップ（現在の作業）

1. Streamlit UIの実装 ✓
   - app.pyの作成 ✓
   - ドキュメントアップロード機能の実装 ✓
   - ドキュメント一覧表示機能の実装 ✓
   - 検索・クエリインターフェースの実装 ✓

2. 統合テストと最適化 ✓
   - エンドツーエンドテストの実装 ✓
   - エラーハンドリングの強化 ✓

#### E2Eテストケース（計画済み）

1. **ドキュメントアップロードテスト**
   - 各種形式（PDF、DOCX、TXT、MD）のファイルをアップロード
   - 大きなファイルのアップロード
   - 非対応形式のファイルをアップロード（エラー処理の確認）

2. **ドキュメント処理テスト**
   - アップロードしたファイルの処理が正常に完了するか
   - 処理の進捗状況が正しく表示されるか
   - 処理結果がベクトルデータベースに正しく保存されるか

3. **ドキュメント一覧テスト**
   - 処理済みドキュメントが正しく一覧表示されるか
   - ドキュメントの内容が正しく表示されるか

4. **検索機能テスト**
   - 単純なクエリでの検索
   - 複雑なクエリでの検索
   - 存在しない情報に対するクエリ（エラー処理の確認）
   - 検索結果の正確性と関連性の確認

5. **統合フローテスト**
   - ドキュメントのアップロードから検索までの一連の流れ
   - 複数ドキュメントの処理と検索
   - セッション状態の維持と復元

## 最近の変更

- DocumentProcessorクラスの実装
- VectorStoreクラスの実装
- RAGクラスの実装
- Streamlit UIの実装（app.py）
- テスト駆動開発（TDD）の実践
- 遅延初期化パターンの導入
- mypy.iniの作成と型チェック設定
- ruffとmypyのエラー修正（全角括弧を半角括弧に変更など）
- ドキュメントのクリア機能の実装
- E2Eテストケースの立案と実施
- RAGプロンプト設計の改善（キーワードクエリへの対応）
- パフォーマンス最適化の見送り（検証用アプリケーションのため）

## アクティブな決定と考慮事項

1. **アーキテクチャ決定**
   - Streamlitを単独で使用し、FastAPIは使用しない
   - LangChainを使用してRAG機能を実装
   - OpenAIの埋め込みモデルを使用
   - ChromaDBをベクトルデータベースとして使用

2. **実装アプローチ**
   - テスト駆動開発（TDD）を採用
   - 段階的な開発と継続的な検証
   - 小さな成功を積み重ねるアプローチ

3. **コーディング規約**
   - Googleスタイルのdocstring形式を使用
   - 型アノテーションを徹底
   - 関数型アプローチを優先（純粋関数、不変データ構造）
   - Ruffとmypyの設定に従う

## 重要なパターンと設計方針

1. **コンポーネント分離**
   - ドキュメント処理、ベクトルデータベース、RAG機能、UIを明確に分離
   - 各コンポーネントは単一責任の原則に従う
   - インターフェースを明確に定義

2. **依存性注入**
   - コンポーネント間の結合度を低減
   - テスト容易性の向上
   - 柔軟な構成変更

3. **エラーハンドリング**
   - 例外は具体的な型で捕捉
   - エラーメッセージは明確で具体的に
   - ユーザーフレンドリーなエラー表示

4. **進捗状況の可視化**
   - 処理の進捗状況をUIに表示
   - 長時間処理の透明性確保
   - ユーザー体験の向上

## 学びと洞察

1. **markitdownの特性**
   - 様々なファイル形式をマークダウンに変換可能
   - 文書構造（見出し、リスト、表、リンクなど）を保持
   - プラグインシステムによる拡張性

2. **テスト駆動開発の効果**
   - 設計の明確化と品質向上
   - 遅延初期化パターンを使用することでテスト時のモック化が容易に
   - モックを活用することでOpenAI APIキーなしでもテスト可能

3. **ベクトルデータベースの特性**
   - チャンク分割の重要性（サイズとオーバーラップの調整）
   - メタデータの活用によるフィルタリング機能
   - 永続化による再利用性の向上

4. **RAG実装の考慮点**
   - 適切なチャンクサイズとオーバーラップの設定が重要
   - 埋め込みモデルの選択が検索精度に影響
   - プロンプト設計が回答品質に大きく影響
     - 質問形式のクエリだけでなく、キーワードのみのクエリにも対応するプロンプト設計が重要
     - システムプロンプトの指示内容によって回答の質が大きく変わる
   - 型チェックの設定が重要（特に外部ライブラリとの統合時）
   - モックを活用したテストが効果的
   - 検索結果がない場合の適切なフォールバック処理が必要

5. **Streamlitの特性**
   - 迅速なUI開発が可能
   - セッション状態管理の理解が重要
   - キャッシュ機能を活用したパフォーマンス最適化

## 現在の課題

1. **技術的課題**
   - 大きなファイルの効率的な処理
   - OpenAI APIキーの安全な管理
   - ベクトルデータベースのパフォーマンス最適化
   - 一度に一つのファイルしかアップロードできない制限

2. **設計上の課題**
   - 適切なチャンクサイズの決定
   - UIの使いやすさとレスポンシブ性の確保
   - 複数ファイルの一括アップロード機能の追加

3. **プロジェクト管理上の課題**
   - 段階的な開発と検証のバランス
   - テストカバレッジの確保
   - ドキュメントの一貫性維持

## E2Eテスト結果

1. **ドキュメントアップロードテスト**: ✓
   - 各種形式のファイルのアップロードと処理が正常に機能
     - 対応形式: PDF、Word、PowerPoint、Excel、テキスト、Markdown、HTML、CSV、JSON、XML、画像ファイル
   - 大きなファイルの処理も問題なく完了
   - サポートされない拡張子のファイルは適切に処理される
   - 制限: 一度に一つのファイルしかアップロードできない

2. **ドキュメント一覧テスト**: ✓
   - 処理済みドキュメントが正しく一覧表示される
   - ドキュメント内容が正しく表示される

3. **検索機能テスト**: ✓
   - 質問形式のクエリに適切に応答（例：「太郎さんは何が好きですか？」→「太郎さんは犬が好きです」）
   - キーワードのみのクエリに関連情報を提供（例：「あああ」→「「あああ」はテスト用Wordファイルに含まれる情報の一部です。」）
   - 存在しない情報に対して適切なメッセージを表示（「その情報はコンテキストに含まれていません」）

4. **改善点**:
   - RAGプロンプト設計の改善により、キーワードのみのクエリにも適切に応答できるようになった
   - システムプロンプトを「質問に答える」から「情報提供を行う」に変更し、クエリの形式に応じた応答を可能にした
   - サポートするファイル形式を拡張し、より多くの種類のドキュメントを処理できるようになった
     - 追加した形式: PowerPoint、Excel、HTML、CSV、JSON、XML、画像ファイル
